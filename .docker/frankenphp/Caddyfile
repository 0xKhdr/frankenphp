{
    # Enable full-duplex for SSE, WebSockets, etc.
    servers {
        enable_full_duplex
    }

    # Global FrankenPHP config
    frankenphp {
        # Auto-scale threads (2x CPU by default)
        num_threads {$FRANKENPHP_NUM_THREADS:auto}
        max_threads {$FRANKENPHP_MAX_THREADS:auto}

        # Timeout if no thread available
        max_wait_time 10s

        # Worker config
        worker {
            file public/worker.php
            num {$OCTANE_WORKERS:6}
            name laravel-worker
            # Watch only in dev: watch /app
            env APP_ENV {$APP_ENV}
            env APP_DEBUG {$APP_DEBUG}
            env LOG_LEVEL {$LOG_LEVEL}
        }

        # Override PHP settings (override php.ini)
        php_ini memory_limit 2G
        php_ini max_execution_time 30
        php_ini opcache.validate_timestamps 0
        php_ini opcache.jit_buffer_size 512M
    }

    # Inject global options via env
    {$CADDY_GLOBAL_OPTIONS}
}

# Main site
{$SERVER_NAME:localhost} {
    root * {$SERVER_ROOT:public}

    # Compression
    encode zstd br gzip

    # PHP server with worker routing
    php_server {
        root public
        split_path .php

        # Route non-static to Laravel
        @laravel {
            not path ^/assets/* ^/css/* ^/js/* ^/images/* ^/favicon.ico ^/robots.txt
            not file
        }
        rewrite @laravel /index.php

        # Optional: dedicated worker for /api
        # worker {
        #     file public/worker.php
        #     match /api/*
        #     num 4
        #     env OCTANE_WORKER_GROUP api
        # }
    }

    # Serve static files
    file_server
}